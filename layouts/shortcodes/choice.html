{{ $labels := slice "A" "B" "C" "D" "E" }}
{{ $lines := split .Inner "\n" }}
{{ $options := slice }}
{{ $answer := "" }}
{{ $explanation := "" }}
{{ $choiceID := printf "choice-%d" (now.UnixNano) }}
{{ $num := .Get "num" | default 4 }}

{{ range $index, $line := $lines }}
  {{ $trimmed := trim $line " \r" }}
  {{ if and (ne $trimmed "") (lt $index (add $num 1)) }}
    {{ $option := replaceRE `^([ABCDEabcde]\.\s+)?` "" $trimmed }}
    {{ $options = $options | append $option }}
  {{ else if eq $index (add $num 1) }}
    {{ $answer = $trimmed }}
  {{ else if ge $index (add $num 2) }}
    {{ $explanation = print $explanation "\n" $line }}
  {{ end }}
{{ end }}

{{ $.Scratch.Set $choiceID $answer }}
<div class="choice-container td-max-width-on-larger-screens" data-answer="{{ $answer }}" id="quiz-{{ $choiceID }}">
  <form>
    {{ range $index, $option := $options }}
    <label class="choice-option">
      <input type="radio" name="{{ $choiceID }}" value="{{ index $labels $index }}" onclick="checkAnswer(this, '{{ $choiceID }}', '{{ $answer }}')">
      <span class="choice-label">{{ index $labels $index }}.</span>
      <span class="choice-text">{{ $option | markdownify }}</span>
    </label>
    {{ end }}
  </form>
  <div class="feedback-area" id="feedback-{{ $choiceID }}"></div>
  <button class="toggle-btn" onclick="toggleExplanation(this, '{{ $choiceID }}')">查看答案与解析</button>
  <div class="explanation" id="explanation-{{ $choiceID }}">
    <strong>正确答案：<span class="correct-answer-text">{{ $answer }}</span></strong><br>
    {{ $explanation | markdownify | safeHTML }}
  </div>
</div>

{{- if not ($.Page.Scratch.Get "quiz-choice-flag") -}}
<style>
/* ... (all other existing styles like .choice-container, .choice-option, etc. remain the same) ... */

.choice-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin: 20px 0;
  padding: 20px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  background-color: #fdfdfd;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}

.choice-option {
  display: flex;
  align-items: center;
  width: 100%;
  padding: 12px 15px;
  border: 1px solid #d1d1d1;
  border-radius: 6px;
  background-color: #ffffff;
  cursor: pointer;
  transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, transform 0.1s ease-in-out;
}

.choice-option:hover {
  background-color: #f0f7ff;
  border-color: #80bfff;
  transform: translateY(-1px);
}

.choice-option input[type="radio"] {
  margin-right: 12px;
  transform: scale(1.1);
  accent-color: #007bff;
}

.choice-label {
  font-weight: bold;
  margin-right: 10px;
  color: #007bff;
}

.choice-text {
  flex: 1;
  font-size: 1em;
  color: #333;
}
.choice-text p {
    margin: 0;
}
.choice-text code {
  color: #c7254e;
  background-color: #f9f2f4;
  padding: 2px 4px;
  border-radius: 4px;
  font-size: 0.9em;
}

.toggle-btn {
  /* Reset button-specific visual styles */
  background-color: transparent;
  border: none;
  border-radius: 0; /* Links typically don't have rounded corners */
  padding: 2px 4px; /* Minimal padding, similar to a link's natural spacing */
  box-shadow: none; /* Ensure no shadow from previous styles */

  /* Link-like styling */
  color: #6c757d; /* A standard subtle grey color */
  font-size: 14px; /* Common link size */
  font-weight: normal; /* Standard weight for link text */
  text-decoration: none; /* No underline by default */
  
  /* Center the button */
  display: flex; /* Make the button a flex container */
  justify-content: center; /* Center content horizontally */
  align-items: center; /* Center content vertically */
  margin: 0 auto; /* Center the button horizontally in its parent */
  align-self: center; /* Override flex-start to center in flex container */
  text-align: center; /* Center the text within the button */

  /* Smooth transition for color change */
  transition: color 0.2s ease-in-out;
}

.toggle-btn:hover,
.toggle-btn:focus {
  color: #343a40; /* Darken on hover/focus */
  text-decoration: underline; /* Add underline on hover/focus */
  background-color: transparent;
  border: none;
  box-shadow: none;
}

.explanation {
  display: none;
  background-color: #e9f5ff;
  padding: 15px;
  border-radius: 6px;
  font-size: 1em;
  line-height: 1.6;
  border: 1px solid #b3d7ff;
  color: #333;
}

.explanation strong {
  color: #0056b3;
  font-weight: 600;
}

.explanation .correct-answer-text {
  font-weight: bold;
  color: #28a745;
}

.feedback-area {
  display: none;
  padding: 10px;
  border-radius: 5px;
  font-weight: bold;
  font-size: 0.95em;
}

.feedback-area.correct {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.feedback-area.incorrect {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
</style>

<script>
// Script remains the same as before
function toggleExplanation(button, choiceID) {
  var explanation = document.getElementById('explanation-' + choiceID);
  if (explanation) {
    explanation.style.display = (explanation.style.display === "none" || explanation.style.display === "") ? "block" : "none";
    button.textContent = (explanation.style.display === "none" || explanation.style.display === "") ? "查看答案与解析" : "隐藏答案与解析";
  }
}

function checkAnswer(input, choiceID, correctAnswer) {
  let selected = input.value.trim();
  let feedbackArea = document.getElementById('feedback-' + choiceID);
  let options = document.querySelectorAll(`#quiz-${choiceID} input[name="${choiceID}"]`);

  options.forEach(opt => {
    opt.disabled = true;
    let optLabel = opt.closest('.choice-option');
    if (optLabel) {
        optLabel.style.cursor = 'default';
        if (opt.value === correctAnswer) {
            optLabel.style.borderColor = '#28a745';
            optLabel.style.backgroundColor = '#e6ffed';
        } else if (opt.checked && opt.value !== correctAnswer) {
            optLabel.style.borderColor = '#dc3545';
            optLabel.style.backgroundColor = '#ffebee';
        }
    }
  });

  if (feedbackArea) {
    if (selected === correctAnswer) {
      feedbackArea.textContent = "✅ 你答对了！";
      feedbackArea.className = 'feedback-area correct';
    } else {
      feedbackArea.textContent = `❌ 答错了。正确答案是 ${correctAnswer}。请查看解析。`;
      feedbackArea.className = 'feedback-area incorrect';
    }
    feedbackArea.style.display = 'block'; // This makes it visible
  } else {
    if (selected === correctAnswer) {
      alert("✅ 你答对了！");
    } else {
      alert(`❌ 答错了。正确答案是 ${correctAnswer}。请查看解析。`);
    }
  }

  if (selected !== correctAnswer) {
    var explanationDiv = document.getElementById('explanation-' + choiceID);
    var toggleButton = document.querySelector(`#quiz-${choiceID} .toggle-btn`);
    if (explanationDiv && explanationDiv.style.display === "none") {
      toggleExplanation(toggleButton, choiceID);
    }
  }
}

if (typeof window.quizChoiceFlag === 'undefined') {
  window.quizChoiceFlag = true;
}
</script>
{{- $.Page.Scratch.Set "quiz-choice-flag" true -}}
{{- end -}}
